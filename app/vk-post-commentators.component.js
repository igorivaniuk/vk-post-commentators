System.register(["angular2/core","angular2/router","./service/error.service","./service/data-store.service","./shared/error-display/error-display.component","./service/vk-api.service","angular2/http"],function(exports_1,context_1){"use strict";var __moduleName=context_1&&context_1.id;var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r};var __metadata=this&&this.__metadata||function(k,v){if(typeof Reflect==="object"&&typeof Reflect.metadata==="function")return Reflect.metadata(k,v)};var core_1,router_1,error_service_1,data_store_service_1,error_display_component_1,vk_api_service_1,http_1;var VkPostCommentatorsApp;return{setters:[function(core_1_1){core_1=core_1_1},function(router_1_1){router_1=router_1_1},function(error_service_1_1){error_service_1=error_service_1_1},function(data_store_service_1_1){data_store_service_1=data_store_service_1_1},function(error_display_component_1_1){error_display_component_1=error_display_component_1_1},function(vk_api_service_1_1){vk_api_service_1=vk_api_service_1_1},function(http_1_1){http_1=http_1_1}],execute:function(){VkPostCommentatorsApp=function(){function VkPostCommentatorsApp(api){this.api=api;this.comments=[];this.users={};this.commentsCount=0;this.loading=false;this.currentPage=0;this.allPage=0;this.sorted="stickers";this.topComments=[]}VkPostCommentatorsApp.prototype.ngOnInit=function(){var _this=this;setInterval(function(){return console.log("comments",_this.comments.length)},5e3)};VkPostCommentatorsApp.prototype.sortBy=function(field){var _this=this;this.sorted=field;var arrUsers=[];Object.keys(this.users).forEach(function(uid){arrUsers.push(_this.users[uid])});arrUsers.sort(function(a,b){if(a[_this.sorted]<b[_this.sorted]){return 1}if(a[_this.sorted]>b[_this.sorted]){return-1}return 0});this.topComments=arrUsers.slice(0,100)};VkPostCommentatorsApp.prototype.commentsLoaded=function(){this.loading=false;var usersHashStats={};this.comments.forEach(function(c){var hasSticker=false;if(c.attachments&&c.attachments.filter(function(cm){return cm.type=="sticker"}).length){hasSticker=true}if(!usersHashStats[c.from_id]){usersHashStats[c.from_id]={count:0,stickers:0,likes:0,items:[],uid:c.from_id}}if(hasSticker){usersHashStats[c.from_id].stickers++}usersHashStats[c.from_id].count++;usersHashStats[c.from_id].likes+=c.likes.count;usersHashStats[c.from_id].items.push(c)});this.users=usersHashStats;this.sortBy(this.sorted)};VkPostCommentatorsApp.prototype.getCommentsPage=function(owner_id,post_id,page){if(page===void 0){page=1}this.currentPage=page;return this.api.method("wall.getComments",{owner_id:owner_id,post_id:post_id,need_likes:true,sort:"asc",offset:page*100-100,count:100})};VkPostCommentatorsApp.prototype.loadCommentsRecursion=function(owner_id,post_id,page){var _this=this;this.getCommentsPage(owner_id,post_id,page).subscribe(function(rs){if(rs.error&&rs.error.error_code==6){setTimeout(function(){console.log("retry");_this.loadCommentsRecursion(owner_id,post_id,page)},1e3);return}_this.comments=_this.comments.concat(rs.response.items);console.log("page",page,rs.response.count);if(rs.response.count>page*100-100){setTimeout(function(){_this.loadCommentsRecursion(owner_id,post_id,++page)},30)}else{console.log("--end--",rs.response.count,page*100-100,rs.response.count<page*100-100);_this.commentsLoaded()}})};VkPostCommentatorsApp.prototype.loadComments=function(owner_id,post_id){var _this=this;this.getCommentsPage(owner_id,post_id).subscribe(function(rs){_this.commentsCount=rs.response.count;_this.comments=rs.response.items;_this.allPage=Math.ceil(_this.commentsCount/100);_this.loadCommentsRecursion(owner_id,post_id,2)})};VkPostCommentatorsApp.prototype.check=function(val){var mch=val.match(/wall(-?\d+)_(\d+)/);if(mch){var owner_id=mch[1];var post_id=mch[2];this.loadComments(owner_id,post_id);this.loading=true}return false};VkPostCommentatorsApp=__decorate([core_1.Component({moduleId:__moduleName,selector:"vk-post-commentators-app",providers:[router_1.ROUTER_PROVIDERS,http_1.JSONP_PROVIDERS,error_service_1.ErrorService,data_store_service_1.DataStoreService,vk_api_service_1.VkApiService],templateUrl:"vk-post-commentators.component.html",styleUrls:["vk-post-commentators.component.css"],directives:[router_1.ROUTER_DIRECTIVES,error_display_component_1.ErrorDisplayComponent],pipes:[]}),router_1.RouteConfig([]),__metadata("design:paramtypes",[vk_api_service_1.VkApiService])],VkPostCommentatorsApp);return VkPostCommentatorsApp}();exports_1("VkPostCommentatorsApp",VkPostCommentatorsApp)}}});
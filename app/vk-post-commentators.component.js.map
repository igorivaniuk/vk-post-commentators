{"version":3,"file":"vk-post-commentators.component.js","sourceRoot":"","sources":["vk-post-commentators.component.ts"],"names":[],"mappings":"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","sourcesContent":["import {Component} from 'angular2/core';\nimport {RouteConfig, ROUTER_DIRECTIVES, ROUTER_PROVIDERS} from 'angular2/router';\nimport {ErrorService} from \"./service/error.service\";\nimport {DataStoreService} from \"./service/data-store.service\";\nimport {ErrorDisplayComponent} from \"./shared/error-display/error-display.component\";\nimport {VkApiService} from \"./service/vk-api.service\";\nimport {JSONP_PROVIDERS} from \"angular2/http\";\n\n@Component({\n  moduleId: __moduleName,\n  selector: 'vk-post-commentators-app',\n  providers: [ROUTER_PROVIDERS, JSONP_PROVIDERS, ErrorService, DataStoreService, VkApiService],\n  templateUrl: 'vk-post-commentators.component.html',\n  styleUrls: ['vk-post-commentators.component.css'],\n  directives: [ROUTER_DIRECTIVES, ErrorDisplayComponent],\n  pipes: []\n})\n@RouteConfig([\n])\nexport class VkPostCommentatorsApp {\n  public comments: any[] = [];\n  public users: any = {};\n  public commentsCount = 0;\n\n  public loading = false;\n  public currentPage = 0;\n  public allPage = 0;\n\n  public sorted = 'stickers';\n\n  public topComments = [];\n\n  constructor(private api: VkApiService) { }\n\n  ngOnInit() {\n    setInterval(() => console.log('comments', this.comments.length), 5000)\n  }\n\n  sortBy(field) {\n    this.sorted = field;\n    let arrUsers = [];\n    Object.keys(this.users).forEach(uid => {\n      arrUsers.push(this.users[uid]);\n    });\n    arrUsers.sort((a, b) => {\n      if (a[this.sorted] < b[this.sorted]) {\n        return 1;\n      }\n\n      if (a[this.sorted] > b[this.sorted]) {\n        return -1;\n      }\n      // a должно быть равным b\n      return 0;\n    });\n    this.topComments = arrUsers.slice(0, 100);\n  }\n\n  commentsLoaded() {\n    this.loading = false;\n    let usersHashStats = {};\n    this.comments.forEach((c: any) => {\n      let hasSticker = false;\n      if (c.attachments && c.attachments.filter(cm => cm.type == 'sticker').length) {\n        hasSticker = true;\n      }\n\n      if (!usersHashStats[c.from_id]) {\n        usersHashStats[c.from_id] = {\n          count: 0,\n          stickers: 0,\n          likes: 0,\n          items: [],\n          uid: c.from_id\n        }\n      }\n\n      if (hasSticker) {\n        usersHashStats[c.from_id].stickers ++;\n      }\n      usersHashStats[c.from_id].count ++;\n      usersHashStats[c.from_id].likes += c.likes.count;\n      usersHashStats[c.from_id].items.push(c);\n    });\n    this.users = usersHashStats;\n    this.sortBy(this.sorted);\n  }\n\n  getCommentsPage(owner_id, post_id, page=1) {\n    this.currentPage = page;\n    return this.api.method('wall.getComments', {\n      owner_id: owner_id,\n      post_id: post_id,\n      need_likes: true,\n      sort: 'asc',\n      offset: page * 100 - 100,\n      count: 100\n    });\n  }\n\n  loadCommentsRecursion(owner_id, post_id, page) {\n    this.getCommentsPage(owner_id, post_id, page)\n        .subscribe(rs => {\n          // if (page > 40) {\n          //   this.commentsLoaded()\n          //   return ;\n          // }\n\n\n          if (rs.error && rs.error.error_code == 6) {\n            setTimeout(() => {\n              console.log('retry');\n              this.loadCommentsRecursion(owner_id, post_id, page);\n            }, 1000);\n            return ;\n          }\n          this.comments = this.comments.concat(rs.response.items);\n          console.log('page', page, rs.response.count);\n\n          if (rs.response.count > ((page * 100) - 100)) {\n            setTimeout(() => {\n              this.loadCommentsRecursion(owner_id, post_id, ++page);\n            }, 10);\n\n\n          } else {\n            console.log('--end--', rs.response.count, ((page * 100) - 100), (rs.response.count < ((page * 100) - 100)));\n\n            this.commentsLoaded()\n          }\n        });\n  }\n\n  loadComments(owner_id, post_id) {\n    this.getCommentsPage(owner_id, post_id)\n        .subscribe(rs => {\n          this.commentsCount = rs.response.count;\n          this.comments = rs.response.items;\n          this.allPage = Math.ceil(this.commentsCount / 100);\n          this.loadCommentsRecursion(owner_id, post_id, 2)\n        })\n  }\n\n  check(val: string) {\n    let mch = val.match(/wall(-?\\d+)_(\\d+)/);\n    if (mch) {\n      let owner_id = mch[1];\n      let post_id = mch[2];\n      this.loadComments(owner_id, post_id);\n      this.loading = true;\n    }\n    return false;\n  }\n}\n"]}